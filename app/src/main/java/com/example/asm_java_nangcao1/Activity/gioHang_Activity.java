package com.example.asm_java_nangcao1.Activity;import androidx.annotation.NonNull;import androidx.appcompat.app.AppCompatActivity;import androidx.recyclerview.widget.DefaultItemAnimator;import androidx.recyclerview.widget.GridLayoutManager;import androidx.recyclerview.widget.RecyclerView;import android.content.Intent;import android.content.SharedPreferences;import android.os.Bundle;import android.os.Handler;import android.view.View;import android.view.animation.Animation;import android.view.animation.AnimationUtils;import android.widget.ImageView;import android.widget.LinearLayout;import android.widget.ListView;import android.widget.TextView;import android.widget.Toast;import com.airbnb.lottie.LottieAnimationView;import com.example.asm_java_nangcao1.Adapter.vertical_listGioHang_Adapter;import com.example.asm_java_nangcao1.Adapter.vertical_listProduc_Adapter;import com.example.asm_java_nangcao1.Model.chiTietGioHang_Model;import com.example.asm_java_nangcao1.Model.gioHang_Model;import com.example.asm_java_nangcao1.Model.khoHang_Model;import com.example.asm_java_nangcao1.R;import com.google.firebase.database.DataSnapshot;import com.google.firebase.database.DatabaseError;import com.google.firebase.database.DatabaseReference;import com.google.firebase.database.FirebaseDatabase;import com.google.firebase.database.ValueEventListener;import java.util.ArrayList;import de.hdodenhof.circleimageview.CircleImageView;public class gioHang_Activity extends AppCompatActivity {    private TextView            GioHang_tv_tongGiaSanPham,            GioHang_tv_showifNullProduc,            GioHang_tv_nameUser,            SanPham_tv_textAnim;    ;    private RecyclerView            GioHang_rscv_produc;    private ImageView            GioHang_img_btn_back,            GioHang_img_showifNullProduc;    private LinearLayout            GioHang_llout_btn_datHang, GioHang_costLout_loanding;    private CircleImageView            GioHang_img_avatarUser;    private LottieAnimationView            SanPham_loadingAnim_lotte;    Animation            SanPham_anim_txtContext;    //    firebase    private DatabaseReference databaseGiohang;    private DatabaseReference databaseChiTietGiohang;    //    Model    ArrayList<gioHang_Model> arrayListGioHang;    ArrayList<chiTietGioHang_Model> arrListChiTietGioHang;    ArrayList<khoHang_Model> arrListKhoHang;    private gioHang_Model arrGioHang;    private khoHang_Model arrKhohang;    private chiTietGioHang_Model arrChiTietGioHang;    //    adtapter    private vertical_listGioHang_Adapter adapter_vetical_gioHang;    double tongTien = 0;    private SharedPreferences shareAcout;    private String idgioHangShr;    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_gio_hang);        anhXa();        anim();        getSharepr();        batSuKien();        firebasGetIdSanPham();        showListGioHang_Vartical();//        setTongGiaSanPham(arrListChiTietGioHang);    }    /********************Anim Loanding**********************/    private void anim() {        anhXa();        SanPham_tv_textAnim.setAnimation(SanPham_anim_txtContext);        SanPham_anim_txtContext.setAnimationListener(new Animation.AnimationListener() {            @Override            public void onAnimationStart(Animation animation) {            }            @Override            public void onAnimationEnd(Animation animation) {//                ánh xạ lotte animation                SanPham_loadingAnim_lotte.setVisibility(View.VISIBLE);//                khởi tạo biến delay                final Handler handler = new Handler();                handler.postDelayed(new Runnable() {                    @Override                    public void run() {//                        sau khi chạy hết khoảng thời gian 1s thì tắt                        GioHang_costLout_loanding.setVisibility(View.INVISIBLE);                    }                }, 1000);            }            @Override            public void onAnimationRepeat(Animation animation) {            }        });    }    /********************lấy dữ liệu từ Sharedpre...**********************/    private void getSharepr() {        shareAcout = getSharedPreferences("AccountSharedPreferences", MODE_PRIVATE);        shareAcout.getString("key_idUserName", "");        shareAcout.getInt("key_quyen", 0);        idgioHangShr = shareAcout.getString("key_idGioHang", "");        shareAcout.getString("key_avatar", "");        shareAcout.getString("key_name", "");        shareAcout.getString("key_userName", "");        shareAcout.getString("key_password", "");        shareAcout.getString("key_diaChi", "");        shareAcout.getInt("key_soDienThoai", 0);        shareAcout.getString("key_gmail", "");    }    /********************bắt sự kiện**********************/    private void batSuKien() {        GioHang_img_btn_back.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                Intent intent = new Intent(gioHang_Activity.this, sanPham_Activity.class);                startActivity(intent);            }        });// mua hàng        GioHang_llout_btn_datHang.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                String giaSpTv = GioHang_tv_tongGiaSanPham.getText().toString();                if (giaSpTv.equals("0.0vnđ")) {//                    show popup                    Toast.makeText(gioHang_Activity.this, "Không có sản phẩm mà đặt hàng à ", Toast.LENGTH_SHORT).show();                } else {                    Intent intent = new Intent(gioHang_Activity.this, xacNhanThongTinDatHang_Activity.class);                    Bundle bundle = new Bundle();                    bundle.putString("key_giaSp", giaSpTv);                    intent.putExtras(bundle);                    startActivity(intent);                }            }        });        GioHang_img_avatarUser.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                Intent intent = new Intent(gioHang_Activity.this, thongTinUser_Activity.class);                startActivity(intent);            }        });    }    /********************Show thông tin ra kiểu dọc**********************/    private void showListGioHang_Vartical() {        GioHang_rscv_produc.setLayoutManager(new GridLayoutManager(this, 1));        GioHang_rscv_produc.setItemAnimator(new DefaultItemAnimator());//        Initilize        adapter_vetical_gioHang = new vertical_listGioHang_Adapter(arrListChiTietGioHang, gioHang_Activity.this);        GioHang_rscv_produc.setAdapter(adapter_vetical_gioHang);    }    /********************lấy dữ liệu từ firebase lấy id số lượng**********************/    private void firebasGetIdSanPham() {        databaseGiohang = FirebaseDatabase.getInstance("https://asmandroid-duan1-default-rtdb.asia-southeast1.firebasedatabase.app/").getReference("Cart").child(idgioHangShr);        databaseGiohang.addValueEventListener(new ValueEventListener() {            public void onDataChange(DataSnapshot snapshot) {                arrayListGioHang.clear();                for (DataSnapshot child : snapshot.getChildren()) {                    arrGioHang = child.getValue(gioHang_Model.class);                    if (arrGioHang.getIdGioHang() != null) {                        arrayListGioHang.add(new gioHang_Model(arrGioHang.getIdGioHang(), arrGioHang.getIdSanPham(), arrGioHang.getSoLuongSanPham()));                    }                }                firebaseData(arrayListGioHang);            }            @Override            public void onCancelled(DatabaseError error) {            }        });    }    public void setTongGiaSanPham(double tongTien) {        String stGia = String.format(tongTien + "");        if (stGia.length() > 6) {            GioHang_tv_tongGiaSanPham.setText(stGia.substring(0, 6) + "00vnđ");        } else if (tongTien == 0) {            GioHang_tv_tongGiaSanPham.setText(tongTien + "vnđ");        } else {            GioHang_tv_tongGiaSanPham.setText(tongTien + "00vnđ");        }    }    /********************lấy dữ liệu từ firebase gán vào arrList**********************/    private void firebaseData(ArrayList<gioHang_Model> arrayListGioHang) {        if (arrayListGioHang.size() == 0) {            setTongGiaSanPham(0);            adapter_vetical_gioHang.notifyDataSetChanged();            GioHang_img_showifNullProduc.setVisibility(View.VISIBLE);            GioHang_tv_showifNullProduc.setVisibility(View.VISIBLE);        } else {            GioHang_img_showifNullProduc.setVisibility(View.INVISIBLE);            GioHang_tv_showifNullProduc.setVisibility(View.INVISIBLE);        }        arrListChiTietGioHang.clear();        tongTien = 0;        for (int i = 0; i < arrayListGioHang.size(); i = i + 1) {            //         Gán giá trị trong firebase            databaseChiTietGiohang = FirebaseDatabase.getInstance("https://asmandroid-duan1-default-rtdb.asia-southeast1.firebasedatabase.app/").getReference().child("khoHang").child(arrayListGioHang.get(i).getIdSanPham());            int finalI = i;            databaseChiTietGiohang.addValueEventListener(new ValueEventListener() {                @Override                public void onDataChange(DataSnapshot snapshot) {                    // gọi dữ liệu trên firebase về                    arrKhohang = snapshot.getValue(khoHang_Model.class);                    // add vào listItemSanpham                    if (arrKhohang.getIdSanPham() != null) {                        arrListChiTietGioHang.add(new chiTietGioHang_Model(arrayListGioHang.get(finalI).getIdGioHang(), arrKhohang.getHinhAnh(), arrKhohang.getTenSanPham(), arrKhohang.getGiaSanPham(), arrayListGioHang.get(finalI).getSoLuongSanPham()));//        lấy được giá item và số lương//            giá tiền                        double giaSanPham = Double.parseDouble(arrListChiTietGioHang.get(finalI).getGiaSanPham());//            số lượng                        int soLuongSanPham = arrListChiTietGioHang.get(finalI).getSoLuongSanPham();//            tính tổng giả tiền                        tongTien = tongTien + (giaSanPham * soLuongSanPham);                        setTongGiaSanPham(tongTien);                    }                    //    gán vào adapter                    adapter_vetical_gioHang.notifyDataSetChanged();                }                @Override                public void onCancelled(DatabaseError error) {                }            });        }    }    /********************lấy dữ liệu từ Adapter**********************/    public void setXoaItem_gioHang(String idGioHang, int viTri) {        databaseGiohang = FirebaseDatabase.getInstance("https://asmandroid-duan1-default-rtdb.asia-southeast1.firebasedatabase.app/").getReference("Cart").child(idgioHangShr);        databaseGiohang.child(idGioHang).removeValue();//        showListGioHang_Vartical();        adapter_vetical_gioHang.notifyItemChanged(viTri);    }    private void anhXa() {        //        anim        SanPham_anim_txtContext = AnimationUtils.loadAnimation(this, R.anim.header_anim);        GioHang_costLout_loanding = findViewById(R.id.gioHang_costLout_loanding);//        lotte        SanPham_loadingAnim_lotte = findViewById(R.id.sanPham_anim_Loanding);        SanPham_tv_textAnim = findViewById(R.id.sanPham_tv_textAnim);//        lotte        SanPham_loadingAnim_lotte = findViewById(R.id.sanPham_anim_Loanding);        SanPham_tv_textAnim = findViewById(R.id.sanPham_tv_textAnim);//        SharedPreferences        shareAcout = getSharedPreferences("AccountSharedPreferences", MODE_PRIVATE);//        Model        arrListKhoHang = new ArrayList<>();        arrListChiTietGioHang = new ArrayList<>();        arrayListGioHang = new ArrayList<>();//        TextView        GioHang_tv_tongGiaSanPham = findViewById(R.id.gioHang_tv_tongGiaSanPham);        GioHang_tv_showifNullProduc = findViewById(R.id.gioHang_tv_showifNullProduc);        GioHang_tv_nameUser = findViewById(R.id.gioHang_tv_nameUser);//        CircleImageView        GioHang_img_avatarUser = findViewById(R.id.gioHang_img_avatarUser);//        Risezecolview        GioHang_rscv_produc = findViewById(R.id.gioHang_rscv_produc);//        ImgView        GioHang_img_showifNullProduc = findViewById(R.id.gioHang_img_showifNullProduc);        GioHang_img_btn_back = findViewById(R.id.gioHang_img_btn_back);//        LinearLayout        GioHang_llout_btn_datHang = findViewById(R.id.gioHang_llout_btn_datHang);        GioHang_tv_tongGiaSanPham.setText("0.0vnđ");    }}